<!DOCTYPE html>
<html>
    <head>
	<meta charset="utf-8">
	<title>Mfs Files Management</title>
    	<style type="text/css">
	 
	 #blockUploadAndRemove {
	     float:left;
	     border:2px solid #0A6BB3;
	     padding:5px;
	     background:#ffffff;
	 }

	 #h3-title {
	     display: block;
	 }

	 #nameButton { 
	     background-color:lightcyan;
	     color:#0000FF;
	     cursor: pointer;
	 }
	 
	 #paddingResult {
	     padding:20px;
	     margin:20px;
	 }

	 .catOfHash {
	     background:#C7F8F6;
	 }

	 .dbug { border: 1px dotted #0A6BB3 }

	 .fileUploadedAndRemoved {
	     background:#58F571;
	     text-align: center;
	     font-size:80%;
	 }

	 .header {
	     border-radius: 15px;
	     padding: 10px;
	     margin:10px;
	     text-align: center;
	     background:#0A6BB3;
	     font-weight: bold;
	     color:white;
	     font-size: 30px;
	     font:"Fira Sans", serif;
	 }

	 .title {
	     border-radius: 10px;
	     padding: 10px;
	     margin:10px;
	     text-align: center;
	     background:#0A6BB3;
	     font-weight: bold;
	     color:white;
	     font:"Fira Sans", serif;
	 }

	 .typeAndHash {
	     padding:10px;
	     margin:10px;
	 }

	 .upload {
	     border-radius:5px;
	     background:#0A6BB3;
	     color:white;
	     font-weight: bold;
	     text-align: center;
	 }
	 
	</style>
    </head>
    <body>
	<div class="header">List of MFS Files and Directories</div>
	
	<div id="blockUploadAndRemove">
	    
	    <!-- Bloc upload -->

    <div class="upload">Upload file to <span id="currentMfsPath">Mfs Directory</span></div><br>
	    <form method=POST>
		<input type=file><br>
		<input type="radio" name="nameoffile" id="idUploadName" checked>Upload with name kept<br>
		<input type="radio" name="nameoffile" id="idUploadNewName">
		<input type="text" onchange="checkedRadio()" name="nameoffile" id="fil_name" placeholder="Upload with name changed"><br>
		<input type=button onclick="uploadFileToCurrentMfs(this.closest('form'))" value="Upload"><br>
		<div class="fileUploadedAndRemoved" id="fileUploaded"></div>
	    </form>

	    <!-- Bloc mkdir -->

	    <div class="upload">Create directory to <span id="currentMfsDir"></span></div><br>
	    <form method=POST>
		<input type="text" id="idNameOfDirectory"><br>
		<input type=button onclick="createDirectory()" id="createDirButton" value="Create"><br>
		<div class="fileUploadedAndRemoved" id="directoryCreated"></div>
	    </form>
	    
	    <!-- Bloc remove -->
	    
	    <div class="upload">Remove file or directory</div><br>
	    <form method=POST>
		<input type="text" id="idRemoveFileOrDirectory" disabled><br>
		<input type=button onclick="removeElement()" id="removeButton" value="Remove" disabled><br>
		<div class="fileUploadedAndRemoved" id="fileRemoved"></div>
	    </form>
	</div>
	<!-- list of Mfs files in directory 'path' -->
	<form>
	    <center>
		<span class="title">
		    Mfs directories <input id="path" name="mfsdir" type="text" value="/">
		    <input type=button onClick="getForm(this.closest('form'))" id="validateClick" value="Display">
		    <input type=button onClick="document.location.reload(true)" type=reset value="Reset page">
		</span>
		<pre id="ls"></pre>
	</form>
	
	<div class="typeAndHash">
	    <div>This Mfs <b><span id="type">type</span></b> has Hash <b><span id="hash">hash</span></b></div>
            <span style="color:red" id="error"></span>
	    <div>
	    </center>	    
	    <table id=ls-result>
		<tr><th colspan=4><h3 id="h3-title" class="upload"></h3></th>
	    </table>
	    </div>
	</div>
	<pre id="catOfHash" class="catOfHash"></pre>

	<script>
	 /**
	  * Rules
	  *  idName start with id, Name refers to Content 
	  * Glossary
	  *  mfsPath = mfsFilePath || mfsFileDir
	  *  mfsFilePath /etc/my/directory/Z_block.txt
	  *  mfsDirPath /etc/my/directory 
	  *  mfsDirName /my
	  *  basename Z_block.txt
	  *  filename Z_block
	  *  name basename || mfsDirName (name of last path element) 
	  *  extension .txt
	  *  imagePath images/file.png
	  */
	 
	 window.onload = displayDirOnLoadWindow();

	 function displayDirOnLoadWindow() {
	     document.getElementById('validateClick').click();
	 }
	 
	 function getForm (form) {
	     console.log("getForm : form.elements ",form.elements);
	     let mfspath = form.elements[0].value;
	     console.log("getForm : mfspath '"+mfspath+"'");

	     updateElementOfIdOfValue ("currentMfsPath", mfspath);
	     updateElementOfIdOfValue ("currentMfsDir", mfspath);
	     getHashAndType (mfspath);
	     getFileList (mfspath)
	 }

	 function getFileList (mfspath) {
	     console.log("getFileList input mfspath",mfspath);

	     const api_url = 'http://127.0.0.1:5001/api/v0/'
	     var url = api_url + 'files/ls?arg=' + mfspath + '&l=true'
	     console.log("getFileList : url '"+url+"'");
	     return fetch(url, { method: "POST", mode: 'cors'})
		 .then (validate)
		 .then (resp => resp.json())
		 .then (body => { body.mfspath = mfspath; return body})
		 .then (displayJson)
		 .catch(err => {console.log(err); logError(err)})
	 }

	 function displayJson (json) {
	     console.log('displayJson input json', json);
	     
	     updateElementOfIdOfValue ('fileUploaded', '');
	     updateElementOfIdOfValue ('error', '');
	     updateElementOfIdOfValue ('catOfHash', '');
	     updateElementOfIdOfValue ('fileRemoved', '');
	     
	     let mfspath = json.mfspath
	     let entries = json.Entries
	     console.log('displayJson mfspath', mfspath);
	     console.log('displayJson entries', entries);
	     
	     table = document.getElementById('ls-result')
	     console.log('displayJson table',table);

	     var i = 1;  // Be careful with deleteRow : length is modified.
	     while (table.rows[i]) {
		 console.log('displayJson Row i',i,table.rows[i].innerHTML);
		 table.deleteRow(i);
	     }
	     console.log('displayJson rows count',table.rows.length);

	     updateElementOfIdOfValue ('h3-title', mfspath);

	     let tr = createElementTable (table,'tr', '');

	     var ent_len = entries.length;
	     try {
		 if (entries == null) throw "entries is null"		 
	     } catch (e) {
		 logError(e);
	     }
	     
	     console.log('displayJson ent_len',ent_len);
	     if (ent_len != 0){
		 createElementTable (tr, 'th', 'Type');
		 createElementTable (tr, 'th', 'Name');
		 createElementTable (tr, 'th', 'Hash')
	     }
	     for (i=0; i<entries.length; i++) {
		 var hash = entries[i]['Hash'];
		 var name = entries[i]['Name'];
		 var hash_link = linkIpfsHash (hash);
		 
		 console.log('displayJson hash',hash);
		 console.log('displayJson name',name);
		 console.log('displayJson hash_link',hash_link);
		 
		 var imagePath = typeOfJsonOfKey (entries, i);
		 console.log('displayJson imagePath',imagePath);
		 let type = entries[i]['Type'];
		 console.log('displayJson type',type);
		 
		 let tr = createElementTable (table,'tr', '');
		 createElementTable (tr, 'td', imagePath);
		 createElementTable (tr, 'td', createButtonOfMfsPath(mfspath,name,type,hash));
		 console.log('displayJson hash',hash);
		 createElementTable (tr, 'td', hash_link);
	     }
	 }
	 
	 function removeElement () {
	     let mfspath = document.getElementById('idRemoveFileOrDirectory').value;
	     console.log("removeElement : mfspath '"+mfspath+"'");
	     let conf_mess = 'Confirmer la suppression de ' + mfspath;
	     var conf = confirm(conf_mess);
	     if (conf == true) {
	     	 removeFileOfMfsPath (mfspath)
	     }		 
	 }

	 function createDirectory() {
	     let path =  document.getElementById('path').value;
	     console.log('createDirectory mfspath ',path);
	     let mfsDirName = document.getElementById('idNameOfDirectory').value;
	     console.log('createDirectory mfsDirName',mfsDirName);
	     if (path == '/'){
		 var path_url = path + mfsDirName;
	     }else {
		 var path_url = path + '/' + mfsDirName;
	     }
	     console.log('createDirectory path_url ',path_url);
	     const api_url = 'http://127.0.0.1:5001/api/v0/';
	     var url = api_url + 'files/mkdir?arg=' + path_url;
	     console.log('createDirectory : url ', url);
	     
	     return fetchPostMkdirForm(path_url, url)
		 .then(_ => {document.getElementById('validateClick').click()})
		 .catch(logError)
	 }

	 function removeFileOfMfsPath(mfspath) {
	     console.log('removeFileOfPath input mfspath',mfspath);

	     let [parent, filename, basename, ext] = chopMfspath (mfspath);
	     console.log('removeFileOfMfsPath parent',parent);
	     const webui = 'http://127.0.0.1:5001';
	     const api_url = webui + '/api/v0/'

	     var url = api_url + 'files/rm?arg='+mfspath+'&force=true'
	     console.log('removeFileOfMfsPath url '+url);
	     return fetch(url, { method: "POST", mode: 'cors'})
	     	 .then (validate)
	     	 .then (resp => {console.log('removeFileOfMfsPath resp',resp)})
	 	 .then (_ => {document.getElementById('path').value = parent})    
		 .then (_ => {document.getElementById('validateClick').click()})
		 .then (_ => {updateElementOfIdOfValue('fileRemoved', 'File or directory deleted')})
		 .then (_ => {document.getElementById('idRemoveFileOrDirectory').value = document.getElementById('path').value})
		 .catch(err => logError(err))
	     
	 }	 

	 function checkedRadio () {
	     let rad = document.getElementById('idUploadNewName');
	     console.log ('checkedRadio rad',rad);
	     rad.checked = true;
	     updateElementOfIdOfValue ("idUploadNewName", rad);
	 }
	 
	 function linkIpfsHash (hash) {
	     let api_url = 'http://127.0.0.1:5001/ipfs/';
	     let link = '<a href="';
	     link += api_url;
	     link += hash;
	     link += '" target="_blank">';
	     link += hash;
	     link += '</a>';
	     console.log ('linkIpfsHash link',link);
	     return link;
	 }

	 function typeOfJsonOfKey (json, key) { // Improve it returns an image
	     let type = json[key]['Type'];
	     console.log ('typeOfJsonOfKey type', type, 'key', key, 'json',json);
	     if (type == 0) { return '<img src="images/file.png" width="25px" height="25">'; }
	     else { return '<img src="images/folder.png" width="25px" height="25">'; }
	 }

	 function sizeOfJsonOfKey (json, key) {
	     let siz = json[key]['Size']
	     if (siz > 0) { return ' ('+siz+' octets) '; }
	     else {return "";}
	 }

	 function createButtonOfMfsPath (mfspath, name, type, hash) { // Improve
	     console.log('createButtonOfMfsPath mfspath',mfspath);
	     console.log('createButtonOfMfsPath name',name);
	     console.log('createButtonOfMfsPath type',type);
	     console.log('createButtonOfMfsPath hash',hash);

	     let but = '<input type="button" id="nameButton" value="';
	     but += name;
	     if (type == 1){
		 but += '" onclick="addNameOnInputMfsPath(this.value)"';
	     } else {
		 but += '" onclick="addNameOfFileOnDeleteBlock(' + "'" + name + "'" + ',' + "'" + hash + "'" + ')"';
		 console.log('createButtonOfMfsPath but',but);
	     }
	     but += '>';
	     return but;
	 }

	 function addNameOfFileOnDeleteBlock(fileName, hash) {
	     console.log('addNameOfFileOnDeleteBlock fileName',fileName);
	     console.log('addNameOfFileOnDeleteBlock hash',hash);
	     
	     var dir = document.getElementById('path').value;
	     console.log('addNameOfFileOnDeleteBlock dir',dir);
	     if (dir != '/') {
		 var path = dir + '/' + fileName;
	     }else {
		 var path = dir + fileName;
	     }
	     console.log('addNameOfFileOnDeleteBlock path',path);
	     document.getElementById('removeButton').disabled = false;
	     var del = document.getElementById('idRemoveFileOrDirectory');
	     del.value = path;
	     getHash(hash);
	 }

	 function addNameOnInputMfsPath (mfspath) {
	     console.log ('addNameOnInputMfsPath mfspath', mfspath);
	     let old_path = document.getElementById('path').value;
	     console.log ('addNameOnInputMfsPath old path', old_path);
	     let path = old_path;
	     if (old_path == '/'){
		 path += mfspath;
	     } else {
		 path += '/';
		 path += mfspath;
	     }
	     console.log ('addNameOnInputMfsPath path', path);
	     var del = document.getElementById('idRemoveFileOrDirectory');
	     del.value = path;
	     var x = document.getElementById('path');
	     x.value = path;
	     document.getElementById('removeButton').disabled = false;
	     document.getElementById('validateClick').click();
	 }

	 function updateElementOfIdOfValue (id, value) {
	     let doc = document.getElementById(id);
	     doc.innerHTML = value;
	 }

	 function createElement (tag, id, value, input_type) {
	     let doc_tag = document.createElement (tag);
	     doc_tag.id = id;
	     doc_tag.value = value;
	     if (tag == 'input') {doc_tag.type = input_type};
	     doc_tag.innerHTML = value;
	     document.body.appendChild (doc_tag);
	 }

	 function createElementTable (ele, tag, value) {
	     let doc = document.createElement (tag);
	     doc.style = "padding:7px";
	     doc.innerHTML = value;
	     ele.appendChild (doc);
	     return doc;
	 }
	 
	 function displayByIdOfTagOfValue (tag, value) {
	     document.getElementById(tag).innerHTML = value
	 }
	 
	 function getCat(hash) {
	     const webui = 'http://127.0.0.1:5001';
	     const api_url = webui + '/api/v0/';
	     
	     console.log('getCat hash '+hash);
	     var url = api_url + 'cat?&arg='+hash
	     console.log('url '+url);
	     return fetchGetTextCors(url)
		 .then( obj => { return Promise.resolve(obj) })
		 .catch(logError)
	 }
	 
	 function uploadFileToCurrentMfs(form) {
	     console.log('uploadFileToCurrentMfs : form.elements ',form.elements);
	     let fakepath = form.elements[0].value
	     let mfspath = document.getElementById('path').value;
	     console.log('uploadFileToCurrentMfs : fakepath ',fakepath)
	     console.log('uploadFileToCurrentMfs : mfspath ',mfspath)
	     let path = mfspath;
	     let file = form.elements[0].files[0]
	     console.log('uploadFileToCurrentMfs : element[0].files ',form.elements[0].files)
	     
	     if (document.getElementById('idUploadNewName').checked) {
		 var name = document.getElementById('fil_name').value;
		 console.log('uploadFileToCurrentMfs checked name',name);
	     } else {
		 var name = form.elements[0]['files'][0].name;
		 console.log('name of file',name);
	     }
	     console.log('uploadFileToCurrentMfs name',name);
	     mfspath += '/';
	     mfspath += name;
	     console.log('mfspath',mfspath);
	     
	     let reader = new FileReader();
	     reader.onload = event => {
		 const content_on_load = event.target.result;
		 console.log('uploadFileToCurrentMfs : content_on_load ',content_on_load)
		 writeOfFileOfContent(mfspath, content_on_load).then(callback('hash'))
	     }

	     reader.readAsText(file,'UTF-8') 
	     
	     let formData = new FormData();
	     formData.append("file", file);
	     console.log('uploadFileToCurrentMfs : formData ',formData)
	     let val = 'File '+name+' uploaded to '+path
	     updateElementOfIdOfValue('fileUploaded',val);
	     console.log ('uploadFileToCurrentMfs txt', val);
	     document.getElementById('validateClick').click();
	 }
	 
	 function writeOfFileOfContent(mfspath, content) {
	     console.log('writeOfFileOfContent input mfspath '+mfspath);
	     console.log('writeOfFileOfContent input content '+content)
	     
	     const api_url = 'http://127.0.0.1:5001/api/v0/'
	     var url = api_url + 'files/write?arg=' + mfspath + '&create=1';
	     console.log('writeOfFileOfContent : url '+url);
	     return fetchPostTextForm(url, content)
		 .then( _ => hashOfMFSFilePath(mfspath) )
		 .then( _ => {document.getElementById('validateClick').click()})
		 .catch(logError)
	 }
	 
	 function hashOfMFSFilePath(mfspath) {
	     const api_url = 'http://127.0.0.1:5001/api/v0/'
	     console.log('hashOfMFSFilePath : input mfspath '+mfspath);
	     var url = api_url + 'files/stat?arg='+mfspath+'&hash=true'
	     console.log('hashOfMFSFilePath : url '+url);
	     return fetchGetTextForm(url)
		 .then( obj => obj.json())
		 .then( json => {
		     console.log('hashOfMFSFilePath : json ',json);
		     console.log("hashOfMFSFilePath : json.Type '"+json.Type+"'");
		     if (json.Type == "error") {
			 const message = 'Error from hashOfMFSFilePath : '+json.Message;
			 console.log("hashOfMFSFilePath : message '"+message+"'")
			 updateElementOfIdOfValue("error", message);
		     }
		     return json.Hash} )
	 }
	 
	 function getHashAndType (mfspath) {
	     console.log('getHashAndType input mfspath '+mfspath)
	     const webui = 'http://127.0.0.1:5001';
	     const api_url = webui + '/api/v0/'
	     
	     var url = api_url + 'files/stat?&arg='+mfspath+'&hash=true&type=true'
	     return fetchGetJson(url)
		 .then( obj => {console.log('getHashAndType obj',obj); return Promise.resolve([obj.Hash, obj.Type]) })
		 .then(callbackTuple ('hash', 'type'))
		 .catch(logError)
	 }

	 function logError (err) {
	     console.log("logError : input err ",err);
	     const message = err.message;
	     console.log("logError : message '"+message+"'");
	     displayByIdOfTagOfValue("error", message);
	     switch (message){
		     
		 case "NetworkError when attempting to fetch resource.":
		     var text = "NetworkError because ipfs has not been launched\nrun : jsm; . config.sh; ipmsd.sh";
		     displayByIdOfTagOfValue("error", text); 
		     break;

		 case "Internal Server Error":
		     var text = "Internal Server Error because ipfs file path was uncorrect";
		     displayByIdOfTagOfValue("error", text); 
		     break;
		     
		 case "Cannot read property 'length' of null":
		     console.log('logError', "Cannot read property 'length' of null");
		     displayByIdOfTagOfValue("error", '');
		     var dir = document.getElementById('path').value;
		     console.log('logError dir', dir);
		     updateElementOfIdOfValue('h3-title', dir + ' is empty');
		     break;

		 case "entries is null":
		     console.log('logError', 'entries is null');
		     displayByIdOfTagOfValue("error", '');
		     var dir = document.getElementById('path').value;
		     console.log('logError dir', dir);
		     updateElementOfIdOfValue('h3-title', dir + ' is empty');
		     break;
		     
		 default:
		     console.log("logError : default err '"+err+"'");
	     } // switch
	 }
	 
	 // library
	 
	 function baseName(mfspath){
	     console.log('baseName input mfspath',mfspath);
	     var base = new String(mfspath).substring(mfspath.lastIndexOf('/') + 1); 
	     if(base.lastIndexOf(".") != -1)       
		 base = base.substring(0, base.lastIndexOf("."));
	     return base;
	 }

	 function chopMfspath(mfspath){
	     console.log('chopMfspath input mfspath',mfspath);
	     //MfsPath is decomposed into [ParentDirectory, BaseName, Filename, Extension]
	     // Ex.: "/my/ceci/Z_block.txt" => ["/my/ceci", "Z_block.txt", "Z_block", ".txt" ]
	     if (mfspath.match('/./')) {
		 [parent,basename] = mfspath.split('/./')
	     } else {
		 let p = mfspath.lastIndexOf('/')
		 // console.log('p: '+p)
		 if (p != 0) {
		     parent = mfspath.substr(0,p)
		     basename = mfspath.substr(p+1)
		 } else {
		     parent = '/';
		     basename = mfspath.substr(1)
		 }
	     }
	     let d = basename.lastIndexOf('.')
	     if (d != -1) {
		 filename = basename.substr(0,d)
		 ext = basename.substr(d)
	     } else {
		 filename = basename
		 ext = ''
	     }
	     let result = [parent,basename,filename,ext]; 
	     console.log('chopMfspath result',result);
	     return result;
	 }

	 function callback (tag) {
	     console.log('callback tag: '+tag)
	     const result = obj => {
		 displayByIdOfTagOfValue(tag, obj); 
	     };
	     return result
	 }
	 
	 function callbackIpfsIo (tag) {
	     console.log('callbackIpfsIo tag: '+tag)
	     const substi = obj => {
		 let text = "<a href=https://ipfs.io/ipfs/"+obj+">"+obj+"</a>";
		 displayByIdOfTagOfValue(tag, text);
	     };
	     return substi
	 }
	 
	 function callbackIpfsLocal (tag) {
	     console.log('callbackIpfsLocal tag: '+tag)
	     const substi = obj => {
		 let text = "<a href=http://127.0.0.1:5001/ipfs/"+obj+">"+obj+"</a>";
		 displayByIdOfTagOfValue(tag, text);
	     };
	     return substi
	 }
	 
	 function callbackTuple (tag1, tag2) {
	     const substi = ([obj1, obj2]) => {
		 let url = linkIpfsHash (obj1);
		 updateElementOfIdOfValue(tag1, url);
		 updateElementOfIdOfValue(tag2, obj2);
	     };
	     return substi
	 }

	 function callbackCat (tag) {
	     console.log('callbackCat tag '+tag)
	     const substi = buf => {
		 let e = document.getElementById(tag);
		 e.innerHTML = buf;
	     };
	     return substi
	 }

	 function IpfsException (message) {
	     this.message = message;
	     this.name = "IpfsException";
	 }

	 function fetchGetTextForm(url) {
	     console.log('fetchGetTextForm : input url '+url);
	     return fetch(url, { method: "GET", mode: 'cors' })
	 }
	 
	 function fetchGetJson (url) {
	     console.log('fetchGetJson input url '+url)
	     return fetch(url, { method: "GET"} )
		 .then(validate)
		 .then( resp => {console.log('fetchGetJson resp',resp); return resp.json()} )
	 }

	 function fetchPostMkdirForm(mfspath, url) {
	     console.log('fetchPostTextForm input msfpath ',mfspath);
	     console.log('fetchPostTextForm input url ',url);
	     
	     let form = new FormData();
	     form.append('file', mfspath)   
	     const result = fetch(url, {
		 method: "POST",
		 mode: 'cors',
		 body: form
	     })
	     return result;
	 }
	 
	 function fetchPostTextForm(url, content) {
	     console.log('fetchPostTextForm input url '+url);
	     console.log('fetchPostTextForm input content '+content);
	     
	     let form = new FormData();
	     form.append('file', content)   
	     const result = fetch(url, {
		 method: "POST",
		 mode: 'cors',
		 body: form
	     })
	     return result;
	 }
	 
	 function fetchGetTextCors(url) {
	     return fetch(url, { method: "GET", mode: "cors"} ).then(validate).then( resp => resp.text() )
	 }	 
	 
	 function getHash(hash) {
	     console.log('getHash hash '+hash)
	     if (hash == "") {
		 alert("Name must be filled out");
		 return false;
	     }
	     getCat(hash).then(callbackCat('catOfHash'))
	 }

	 function validate (resp) {
	     if (resp.status >= 200 && resp.status < 300) {
		 return Promise.resolve(resp)
	     }
	     return Promise.reject(new Error(resp.statusText))
	 }

	</script>
    </body>
</html>
