<pre>Your IPaddress is : <span id=ip>ip</span></pre>
<pre>Your PeerId is : <span id=peerid>peerid</span></pre>
<pre>Your Spot is : <span id=spot>spot</span></pre>

<!--
     "--- # spot for $peeId\n"
     "tic: $tic\n"
     "ip: $ipSys\n"
     "spot: $spot

     https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all

-->

<script>
 const webui = 'http://127.0.0.1:5001';
 //const webui = '{{site.data.ipfs.webui}}'
 const api_url = webui + '/api/v0/'

 var spotMap = new Map();

 getPeerID().then(callback('peerid'));
 getIp().then(callback('ip'));

 let result = provideSpot();
 console.log('provideSpot result '+result);

 function isStoredSpot() {
     const result = spotMap.has("spot");
     console.log('isStoredSpot result '+result);
     return result;
 }

 function retrieveSpot() {
     const result = spotMap.get("spot");
     console.log('retrieveSpot result '+result);
     return result;
 }

 function provideSpot() {
     console.log('Entering in provideSpot');
     var result;
     if(isStoredSpot()) {
	 result = retrieveSpot();
     }
     else {
	 result = buildAndStoreOfSpot();
	 console.log('provideSpot X result '+result);
	 document.getElementById('spot').innerHTML = result;

     }
     console.log('provideSpot result '+result);
     return result; 
 }

 function buildAndStoreOfSpot() {
     console.log('Entering in buildAndStoreOfSpot');
     var spot;
     Promise.all([getIp(), getPeerID()]).then(data => {
	 const [ip, peeId] = data;
	 console.log('buildAndStoreOfSpot ip '+ip);
	 console.log('buildAndStoreOfSpot peeId '+peeId);
	 spot = buildSpotOfIpOfPeerId(ip, peeId);
	 spotMap.set("spot", spot)
	 console.log('buildAndStoreOfSpot spot has been stored with '+spot);
	 return spot; 
     }).then(callback('spot'))

 }

 function buildSpotOfIpOfPeerId(ip, peeId) {
     console.log('buildSpotOfIpOfPeerId input ip '+ip)
     console.log('buildSpotOfIpOfPeerId input peeId '+peeId)
     const tic = getTic();
     var ipInt = dot2Int(ip);
     var spot = (tic ^ +ipInt)>>>0;
     
     var result = "--- # spot for "+peeId+"\n";
     result += "tic: "+tic+"\n";
     result += "ip: "+ipInt+"\n";
     result += "spot: "+spot;
     
     console.log('buildSpotOfIpOfPeerId result '+result);
     return result;
 } 
 
 function getIp() {
     let url = 'https://iph.heliohost.org/cgi-bin/jsonip.pl'
     var result = fetchJsonCors(url)
	 .then( obj => { return Promise.resolve(obj.ip) })
	 .catch(logError)
     console.log('getIp result '+result);
     return result
 }

 function getPeerID() {
     let url = api_url + 'config?&arg=Identity.PeerID&encoding=json';
     console.log('getPeerID url '+url);
     var result = fetchJsonGet(url)
	 .then( obj => { return Promise.resolve(obj.Value) })
	 .catch(logError)
     console.log('getPeerID result '+result);
     return result
 }
 
 function fetchJsonCors(url) {
     console.log('fetchJsonCors url '+url)
     return fetch(url, {mode: "cors"} ).then(validate)
				       .then( resp => resp.json() )
 }
 
 function fetchJsonGet(url) {
     console.log('fetchJsonGet url '+url)
     return fetch(url, { method: "GET"} ).then(validate).then( resp => resp.json() )
 }
 
 function getTic() {
     var date = new Date();
     var result =parseInt (date.getTime() / 1000);
     console.log('getTic result '+result)
     return result
 }
 
 function dot2num(dip) {
     console.log('dot2num dip '+dip)
     let atoms = dip.split('.');
     var nip = 0;
     for (let i = 3; i >= 0; i--) {
	 nip |= (+parseInt(atoms[3 - i]) << (i * 8));
	 console.log('dot2num nip: '+nip)
     }
     return nip>>>0
 }
 
 function dot2Int(dot) {
     let d = dot.split('.');
     result = ((((((+d[0])*256)+(+d[1]))*256)+(+d[2]))*256)+(+d[3]);
     console.log('dot2Int result '+result)
     return result
 }
 
 function callback(tag) {
     const substi = obj => {
	 let e = document.getElementById(tag);
	 e.innerHTML = obj;
     };
     return substi
 }
 
 function validate(resp) {
     if (resp.status >= 200 && resp.status < 300) {
	 return Promise.resolve(resp)
     } else {
	 console.log('status:',resp.status)
	 return Promise.reject(new Error(resp.statusText))
     }
 }
 
 function logError(err) { console.log("logError "+err); }
 
</script>


