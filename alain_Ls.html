<html>
    <head>
    	<style type="text/css">
	 #name_link {
	     background-color:lightcyan;
	     color:#0000FF;
	     cursor: pointer;
	 }
	 .header {
	     border-radius: 15px;
	     padding: 10px;
	     margin:10px;
	     text-align: center;
	     background:#0A6BB3;
	     font-weight: bold;
	     color:white;
	     font-size: 30px;
	     font:"Fira Sans", serif;
	 }

	 #block_right {
	     float:right;
	     border:2px solid #0A6BB3;
	     padding:5px;
	 }
	</style>
	<script src="alain_UploadFileToIpfs.js" type='text/javascript'></script>
    </head>
    <body>
	<div class="header">List of a MFS Files and Directories</div>
	<span id="block_right">
	    <center>Upload file to path of MFS</center><br>
	    <form method=POST>
		<input type=file><br>
		<input type=button onClick="writeFile(this.closest('form'))" value="Upload">
	    </form>
	</span>
	<form method=POST>
	    Local Ipfs path <input id="path" name=mfspath type=text placeholder="mfs path">
	    <input type=button onClick="getForm(this.closest('form'))" value="Check">
	    <input type=button onClick="document.location.reload(true)" value="Reset page">
	    <pre id="ls"></pre>
	</form>
	<pre>This Mfs <b><span id=type>type</span></b> has Hash <b><span id=hash>hash</span></b></pre>
        <p style="color:red" id="error"></p>
	
	<script>

	 function getForm(form) {
	     console.log("getForm : form.elements ",form.elements);
	     let mfspath = form.elements[0].value;
	     console.log("getForm : mfspath '"+mfspath+"'");

	     getHashAndType(mfspath);
	     getFileList(mfspath)
	 }
	 
	 function getFileList(mfspath) {
	     const api_url = 'http://127.0.0.1:5001/api/v0/'
	     var url = api_url + 'files/ls?arg=' + mfspath + '&l=true'
	     console.log("getFileList : url '"+url+"'");
	     return fetch(url, { method: "POST", mode: 'cors'})
		 .then (validate)
	     	 .then (resp => resp.json())
		 .then (body => {return body.Entries})
		 .then (displayJson)
		 .catch(logError)
	 }
	 
	 function linkIpfsHash (hash) {
	     let api_url = 'http://127.0.0.1:5001/ipfs/';
	     let link = '<a href="';
	     link += api_url;
	     link += hash;
	     link += '" target="_blank">';
	     link += hash;
	     link += '</a>';
	     console.log ('linkIpfsHash link',link);
	     return link;
	 }

	 function typeOfKeyOfJson (key,json) {
	     let typ = json[key]['Type'];
	     if (typ == 0) { return '<img src="images/file.png" width="25px" height="25">'; }
	     else { return '<img src="images/folder.png" width="25px" height="25">'; }
	 }

	 function sizeOfFile(key,json) {
	     let siz = json[key]['Size'];
	     if (siz > 0) { return ' ('+siz+' octets) '; }
	     else {return "";}
	 }

	 function createButtonOfMfsPath (mfspath) {
	     let but = '<input type="button" id="name_link" value="';
	     but += mfspath;
	     but += '/';
	     but += '" onclick="addNameOnInputMfsPath(this.value)"';
	     but += '">';
	     return but;
	 }

	 function addNameOnInputMfsPath (mfspath) {
	     console.log ('addNameOnInputMfsPath name', mfspath);
	     let old_path = document.getElementById('path').value;
	     console.log ('addNameOnInputMfsPath old path', old_path);
	     let path = old_path;
	     path += mfspath;
	     console.log ('addNameOnInputMfsPath path', path);
	     var x = document.getElementById('path');
	     x.value = path;
	 }
	 
	 function displayJson(json) {
	     console.log('displayJson json', json);
	     let path = document.getElementById('path').value;
	     createElement ('hr', '','');
	     createElement ('h3', 'h3id', path);
	     for (i=0; i<json.length; i++) {
		 var hash = json[i]['Hash'];
		 var name = json[i]['Name'];
		 console.log('displayJson name',name);
		 var hash_link = linkIpfsHash (hash);
		 var fil_dir = typeOfKeyOfJson (i,json);
		 var siz = sizeOfFile(i,json)
		 var line = fil_dir + ' <b> ' + createButtonOfMfsPath(name) + '</b> ' + siz + hash_link;
		 createElement ('li', i, line);
	     }
	 }

	 function createElement (balise, id, value, input_type) {
	     
	     let doc_balise = document.createElement(balise);
	     doc_balise.id = id;
	     doc_balise.value = value;
	     if (balise == 'input') {doc_balise.type = input_type};
	     doc_balise.innerHTML = value;
	     document.body.appendChild(doc_balise);
	 }
	 
	 
	 function validate(resp) {
	     if (resp.status >= 200 && resp.status < 300) {
		 return Promise.resolve(resp)
	     }
	     return Promise.reject(new Error(resp.statusText))
	 }

	 function displayByIdOfTagOfValue(tag, value) {
	     document.getElementById(tag).innerHTML = value
	 }
	 
	 function logError(err) {
	     console.log("logError : input err ",err);
	     const message = err.message;
	     console.log("logError : message '"+message+"'");
	     document.getElementById("error").innerHTML = message;
	     switch (message){
		 case "NetworkError when attempting to fetch resource.":
		     document.getElementById("error").innerHTML = "NetworkError because ipfs has not been launched\nrun : jsm; . config.sh; ipmsd.sh";
		     return process.abort();
		     break;
		 case "Internal Server Error":
		     document.getElementById("error").innerHTML = "Internal Server Error because ipfs file path was uncorrect";
		     return process.abort();
		     break;
		 default:
		     console.log("logError : output err '"+err+"'");
	     } // switch
	 }
	 
	 function callback(tag) {
	     console.log('callback tag: '+tag)
	     const result = obj => {
		 let e = document.getElementById(tag);
		 console.log("callback obj:",obj)
		 e.innerHTML = obj;
	     };
	     return result
	 }
	 
	 function callbackIpfsIo(tag) {
	     console.log('callbackIpfsIo tag: '+tag)
	     const substi = obj => {
		 let e = document.getElementById(tag);
		 e.innerHTML = "<a href=https://ipfs.io/ipfs/"+obj+">"+obj+"</a>";
	     };
	     return substi
	 }
	 
	 function callbackIpfsLocal(tag) {
	     console.log('callbackIpfsLocal tag: '+tag)
	     const substi = obj => {
		 let e = document.getElementById(tag);
		 e.innerHTML = "<a href=http://127.0.0.1:5001/ipfs/"+obj+">"+obj+"</a>";
	     };
	     return substi
	 }
	 
	 function IpfsException(message) {
	     this.message = message;
	     this.name = "IpfsException";
	 }

	 function getHashAndType(mfspath) {
	     console.log('getHashAndType input mfspath '+mfspath)
	     const webui = 'http://127.0.0.1:5001';
	     const api_url = webui + '/api/v0/'
	     
	     var url = api_url + 'files/stat?&arg='+mfspath+'&hash=true&type=true'
	     return fetchGetJson(url)
		 .then( obj => {console.log('getHashAndType obj',obj); return Promise.resolve([obj.Hash, obj.Type]) })
		 .then(callbackTuple('hash','type'))
		 .catch(logError)
	 }

	 function fetchGetJson(url) {
	     console.log('fetchGetJson input url '+url)
	     return fetch(url, { method: "GET"} )
		 .then(validate)
		 .then( resp => {console.log('fetchGetJson resp',resp); return resp.json()} )
	 }
	 
	 function callbackTuple(tag1, tag2) {
	     const substi = ([obj1, obj2]) => {
		 document.getElementById(tag1).innerHTML = obj1;
		 document.getElementById(tag2).innerHTML = obj2;
	     };
	     return substi
	 }


	</script>

	
    </body>
</html>
