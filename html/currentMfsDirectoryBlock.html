<!-- CurrentMfsDirectoryBlock -->
<form method="POST" name="CurrentMfsDirectoryForm">
    <center>
	<span class="title">
	    Current Mfs directory <input type="text" name="CurrentMfsDirectoryName" id="CurrentMfsDirectoryId" value="/" onkeyup="callFunctionWhenEnterEvent(event, getForm()">
	    <input type="button" onClick="getCurrentMfsDirectory()" id="CurrentMfsDirectoryClickId" value="Display">
	    <input type="button" onClick="document.location.reload(true)" value="Reset page">
	</span>
	<pre id="ls"></pre>
</form>

<div class="typeAndHash">
    <div>This Mfs <b><span id="type">type</span></b> has Hash <b><span id="hash">hash</span></b></div>
    <span style="color:red" id="error"></span>
    <div>
    </center>	    
    <table id=ls-result>
	<tr><th colspan=4><h3 id="h3-title" class="whiteOnDarkBlue"></h3></th>
    </table>
    </div>
</div>

<script>
 
 function getCurrentMfsDirectory(){
     let [callee, caller] = functionNameJS();
     console.log('Entering in',callee,'called by',caller);

     let form = getFormOfName("CurrentMfsDirectoryForm");
     let mfspath = mfsPathOfForm(form);
     console.log(callee+'.mfspath',mfspath);

     updateElementOfIdOfValue ("UploadId", mfspath);
     updateElementOfIdOfValue ("currentMfsDir", mfspath);
     getHashAndTypeOfMfsPath (mfspath);
     getFileList (mfspath)
 }

 function getFileList (mfsDirPath) {
     let [callee, caller] = functionNameJS();
     console.log('Entering in',callee,'called by',caller);
     console.log(callee+'.input.mfsDirPath:',mfsDirPath);

     const api_url = 'http://127.0.0.1:5001/api/v0/'
     var url = api_url + 'files/ls?arg=' + mfsDirPath + '&l=true'
     console.log('getFileList.url:',url);
     return fetch(url, { method: "POST", mode: 'cors'})
	 .then (validate)
	 .then (resp => resp.json())
	 .then (body => { body.mfspath = mfsDirPath; return body})
	 .then (displayJson)
	 .catch(err => {console.log(err); logError(err)})
 }

 function displayJson (json) {
     let [callee, caller] = functionNameJS();
     console.log('Entering in',callee,'called by',caller);
     console.log(callee+'.input.json:', json);
     
     let mfsDirPath = json.mfspath
     let entries = json.Entries
     console.log(callee+'.mfsDirPath:', mfsDirPath);
     console.log(callee+'.entries:', entries);
     
     table = document.getElementById('ls-result')
     console.log(callee+'.table:',table);
     
     deleteActionsAndErrorTexts();
     deleteAllRowsOfTable (table);
     updateElementOfIdOfValue ('h3-title', mfsDirPath);

     try {
	 if (entries == null) throw "entries is null"		 
     } catch (e) {
	 logError(e);
     }

     if (entries.length != 0){
	 createHeaderOfTable (table);
     }
     
     createTableOfEntriesOfMfsDirPath (entries, mfsDirPath);
 }

 function deleteActionsAndErrorTexts() {  // Improve
     let [callee, caller] = functionNameJS();
     console.log('Entering in',callee,'called by',caller);
     
     updateElementOfIdOfValue ('fileUploaded', '');
     updateElementOfIdOfValue ('error', '');
     updateElementOfIdOfValue ('fileRemoved', '');
 }

 function getFormOfName(nameForm) {
     let [callee, caller] = functionNameJS();
     console.log('Entering in',callee,'called by',caller);
     console.log(callee+'.nameForm:',nameForm);

     let forms = document.getElementsByName(nameForm);
     console.log(callee+'.forms:',forms);

     let form = forms[0];
     let name = form.name;
     console.log(callee+'.name:',name);
     console.log(callee+'.form:',form);

     let elements = form.elements;
     console.log(callee+'.elements:',elements);
     for (let e=0; e <elements.length; e++) {
 	 let ele = elements[e];
	 console.log(callee+'.ele:',ele);
	 console.log(callee+'.ele.tag:',ele.tagName);
	 console.log(callee+'.ele.id:',ele.id);
	 console.log(callee+'.ele.type:',ele.type);
	 console.log(callee+'.ele.name:',ele.name);
	 console.log(callee+'.ele.value:',ele.value);
     }

     return form;
 }

 function mfsPathOfForm(form) {
     console.log('mfsPathOfForm.input.form:',form);

     let name = form.name;
     console.log('mfsPathOfForm.name:',name);

     let result = form.elements[0].value;
     console.log('mfsPathOfForm.result:',result);
     return result;
 }	     

 function getHashAndTypeOfMfsPath (mfspath) {
     console.log('getHashAndTypeOfMfsPath.input.mfspath:',mfspath)

     const webui = 'http://127.0.0.1:5001';
     const api_url = webui + '/api/v0/'
     
     var url = api_url + 'files/stat?&arg='+mfspath+'&hash=true&type=true'
     return fetchGetJson(url)
	 .then( obj => {console.log('getHashAndTypeOfMfsPath obj',obj); return Promise.resolve([obj.Hash, obj.Type]) })
	 .then(callbackTuple ('hash', 'type'))
	 .catch(logError)
 }

 function callbackTuple (tag1, tag2) {
     console.log('callbackTuple.input.tag1:',tag1)
     console.log('callbackTuple.input.tag2:',tag2)
     
     const substi = ([obj1, obj2]) => {
	 let url = linkIpfsHash (obj1);
	 updateElementOfIdOfValue(tag1, url);
	 updateElementOfIdOfValue(tag2, obj2);
     };
     return substi
 }

 function validate (resp) {
     console.log('validate.input.resp:',resp);
     
     if (resp.status >= 200 && resp.status < 300) {
	 return Promise.resolve(resp)
     } else {
	 console.log('status:',resp.status)
	 return Promise.reject(new Error(resp.statusText))
     }
 }

 function linkIpfsHash (hash) {
     console.log ('linkIpfsHash.input.hash:',hash);
     
     let api_url = 'http://127.0.0.1:5001/ipfs/';
     let link = '<a href="';
     link += api_url;
     link += hash;
     link += '" target="_blank">';
     link += hash;
     link += '</a>';
     console.log ('linkIpfsHash link',link);
     return link;
 }

</script>
<!-- End of CurrentMfsDirectoryBlock -->
