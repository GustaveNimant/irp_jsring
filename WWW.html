<!DOCTYPE html>
<meta charset="utf8"/>
<pre>Local File <b><span id=file>file</span></b> has been stored as Local Ipfs File <b><span id=filPat>filPat</span></b></pre>
<pre>with Hash <span id=hash>hash</span> </pre>

<form id="form">
    File name: <input type="file" name="filNam"><br>
    Directory name: <input type="text" name="dirNam" value="trac"><br>
    <input type="submit" onclick="myFunction()" value="Submit">
</form>

<script>
 const api_url = 'http://127.0.0.1:5001/api/v0/'
 const path = 'http://127.0.0.1/js/irp_jsring/' // ???
 
 function myFunction() {
     console.log('Entering in myFunction');
     var x = document.getElementById("form");
     var filNam = x.elements[0].value;
     console.log('filNam '+filNam);
     var dirNam = x.elements[1].value;
     console.log('dirNam '+dirNam);
     var filPat = dirNam + filNam;
     return new Promise((resolve) => {
	 const value = filPat;
	 resolve(value);
     })
 }

 readFile(filNam)
     .then( content => {
	 console.log('Readfile: content ',content);
	 (writeOfFileOfContent(filNam, content))
     } )
 
 function writeOfFileOfContent(filNam, content) {
     console.log('writeOfFileOfContent input filNam '+filNam);
     console.log('writeOfFileOfContent input content '+content)

     var filPat = dirNam + filNam
     console.log('writeOfFileOfContent filPat '+filPat)
     document.getElementById('filPat').innerHTML = filPat;
     
     var url = api_url + 'files/write?arg=' + filPat + '&create=1&truncate=1';
     console.log('writeOfFileOfContent : url '+url);

     return fetchPostTextForm(url, content)
	 .then( obj => obj.json() )
     	 .then( json => {return json.Hash} )
         .catch(logError)
 }

 readFile(filNam)
     .then( content => {
	 console.log('Readfile: content ',content);
	 return (hashOfFileOfContent(filNam, content))
     })
     .then(callbackIpfsIo('hash') )
 
 function readFile(filNam) {
     console.log('readFile filNam '+filNam);
     return fetch(filNam)
	 .then( resp => { console.log(resp); return resp.text()  } )
	 .catch(logError) 
 }
 
 function hashOfFileOfContent(filNam, content) {
     console.log('hashOfFileOfContent input filNam '+filNam);
     console.log('fetchPostTextForm input content '+content);
     
     var url = api_url + 'add?arg='+filNam
     console.log('hashOfFileOfContent url: '+url);
     
     document.getElementById('file').innerHTML = filNam;
     
     return fetchPostTextForm(url, content)
	 .then( obj => obj.json() )
	 .then( json => {return json.Hash} );
 }
 
 function fetchPostTextForm(url, content) {
     console.log('fetchPostTextForm input url '+url);
     console.log('fetchPostTextForm input content '+content);
     
     let form = new FormData();
     form.append('file', content)   
     return fetch(url, {
	 method: "POST",
	 mode: 'cors',
	 body: form
     })
 }
 
 function callback(tag) {
     const result = obj => {
	 let e = document.getElementById(tag);
	 e.innerHTML = obj;
     };
     return result
 }
 
 function callbackIpfsIo(tag) {
     console.log('callback tag: '+tag)
     const substi = obj => {
	 let e = document.getElementById(tag);
	 e.innerHTML = "<a href=https://ipfs.io/ipfs/"+obj+">"+obj+"</a>";
     };
     return substi
 }

 function callbackIpfsLocal(tag) {
     console.log('callback tag: '+tag)
     const substi = obj => {
	 let e = document.getElementById(tag);
	 e.innerHTML = "<a href=http://127.0.0.1:5001/ipfs/"+obj+">"+obj+"</a>";
     };
     return substi
 }

 function validate(resp) {
     if (resp.status >= 200 && resp.status < 300) {
	 return Promise.resolve(resp)
     }
     return Promise.reject(new Error(resp.statusText))
 }
 
 function logError(err) { console.log(err); }

</script>
